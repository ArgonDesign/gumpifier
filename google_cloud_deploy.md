Deploying on Google Cloud
=========================

This note explains how to deploy **gumpifier** on Google Cloud. Deploying in the cloud is safer than running on a local machine and exposing that to the Internet.

The deployment takes a Docker image generated by `make dockerbuild` and deploys it on Google Kubernetes Engkine (GKE). The commands below create a cluster with a single node. More nodes can be added seamlessly to change the scale of deployment. Updates to **gumpifier** can also be deployed without taking down the service.

Useful websites:

* [1] https://cloud.google.com/kubernetes-engine/docs/tutorials/hello-app
* [2] https://cloud.google.com/docs/authentication/getting-started
* [3] https://cloud.google.com/kubernetes-engine/docs/tutorials/configuring-domain-name-static-ip
* [4] https://cloud.google.com/logging/docs/reference/tools/gcloud-logging
* [5] https://cloud.google.com/sdk/gcloud/reference/ (reference)
* [6] https://kubernetes-v1-4.github.io/docs/user-guide/kubectl/kubectl/ (reference - old but easier to read)

Google Cloud console https://console.cloud.google.com. 

Prerequisites:

1. A valid Docker image for **gumpifier**, created by `make dockerbuild` and possibly tested locally with `docker_run.sh`.

2. [Google Cloud SDK](https://cloud.google.com/sdk/docs/quickstarts) installed, which includes the `gcloud` command line tool.

3. Kubernetes command line tool `kubectl` installed using `gcloud components install kubectl`.


Steps
-----

### 1. Tag the Docker Image and push it to Google Cloud

Use `docker tag` to take a copy of the image and name it suitably for uploading to the Google Container Repository. The tag V\<n\> (for instance `V5`) is added to make it easy to later deploy a new version.

The login credentials for Google Cloud need to be set by creating the environment variable `GOOGLE_APPLICATION_CREDENTIALS` pointing to the credentials file. This is obtained as per [2]. The credentials are needed for all subsequent operations.

```bash
$ docker tag gumpifier gcr.io/argon-design/gumpifier:V<n>
$ export GOOGLE_APPLICATION_CREDENTIALS="/home/sjb/argon-design-47bf86d99dfe.json"
$ gcloud docker -- push gcr.io/argon-design/gumpifier:V<n>
```

### 2. Create Cluster

```bash
$ gcloud config set compute/zone europe-west1-b
$ gcloud config set project argon-design
$ gcloud container clusters create gumpifier-cluster --num-nodes=1
```

You can see the cluster on the Cloud Console at https://console.cloud.google.com/kubernetes/. The cluster `europe-west1-b` is in Belgium. We prefer trustworthy Europe to the US or Brexity Blighty...

### 3. Reserve an External IP Address

```bash
$ gcloud compute addresses create gumpifier-ip --region europe-west1
```

Note the address returned in the command output. We will refer to it as **\<AFIDDLE-IP\>**.

To get info on the IP address subsequently:

```bash
$ gcloud compute addresses describe gumpifier-ip --region europe-west1
```

### 4. Deploy the Image to the Cluster

```bash
$ kubectl run gumpifier-web --image=gcr.io/argon-design/gumpifier:V<n> --port 80
$ kubectl expose deployment gumpifier-web --type=LoadBalancer --load-balancer-ip <GUMPIFIER-IP> --port 80 --target-port 80
```

You can check the service has been created with `kubectl get service`.

You should now be able to see **Gumpifier** in a browser at http://\<Gumpifier-IP\>.

### 5. Set DNS Record to Point to **\<GUMPIFIER-IP\>**

Go to the DNS records for the domain where you want to install **Gumpifier** (in our case use the web console for 1&1 Internet) and set the DNS A record for the domain/subdomain to **\<GUMPIFIER-IP\>**.


Logs
----

Not sorted out yet...


Updating
--------

The pods can be automatically updated (in a rolling fashion if the cluster has more than one node) to a new Docker image.

```bash
$ gcloud docker -- push gcr.io/argon-design/gumpifier:V<n+1>
$ kubectl set image deployment/gumpifier-web gumpifier-web=gcr.io/argon-design/gumpifier:V<n+1>
```
